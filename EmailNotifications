pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                // Tool: Maven
                echo 'Building the code using Maven...'
            }
        }

        stage('Unit and Integration Tests') {
            steps {
                script {
                    def testLogContent = ""
                    try {
                        echo 'Running unit tests using JUnit...'
                        sleep(1) // Simulate unit tests

                        echo 'Running integration tests using TestNG...'
                        sleep(1) // Simulate integration tests

                        testLogContent = "Unit Tests: PASSED\nIntegration Tests: PASSED\nTotal Tests Executed: 50\nFailed: 0"
                        writeFile file: 'test-results.log', text: testLogContent

                        currentBuild.result = 'SUCCESS'
                    } catch (Exception e) {
                        testLogContent = "Test Execution FAILED\nError: ${e.getMessage()}\nStack Trace: ${e.getStackTrace().join('\n')}"
                        writeFile file: 'test-results.log', text: testLogContent
                        
                        currentBuild.result = 'FAILURE'
                        error("Tests failed: ${e.getMessage()}")
                    } finally {
                        archiveArtifacts artifacts: '**/*.log'

                        // Send email notification with log attachment
                        emailext(
                            to: 'situ.xiaolin667@gmail.com',
                            subject: "Unit and Integration Tests - ${currentBuild.result}",
                            body: """
The unit and integration tests have finished with status: ${currentBuild.result}

Please find the attached test results log.

Build URL: ${env.BUILD_URL}
""",
                            attachments: 'test-results.log'
                        )
                    }
                }
            }
        }

        stage('Code Analysis') {
            steps {
                echo 'Analyzing code with SonarQube...'
            }
        }

        stage('Security Scan') {
            steps {
                script {
                    def securityLogContent = ""
                    try {
                        echo 'Performing security scan using OWASP ZAP...'
                        sleep(1) // Simulate security scan
                        
                        securityLogContent = "Security Scan Results:\n- Vulnerabilities Found: 0\n- Warnings: 2\n- Scan Duration: 5 minutes\n- Status: COMPLETED_SUCCESSFULLY"
                        writeFile file: 'security-scan.log', text: securityLogContent

                        currentBuild.result = 'SUCCESS'
                    } catch (Exception e) {
                        securityLogContent = "Security Scan FAILED\nError: ${e.getMessage()}\nScan Status: ABORTED"
                        writeFile file: 'security-scan.log', text: securityLogContent
                        
                        currentBuild.result = 'FAILURE'
                        error("Security scan failed: ${e.getMessage()}")
                    } finally {
                        archiveArtifacts artifacts: '**/*.log'

                        // Send email notification with log attachment
                        emailext(
                            to: 'situ.xiaolin667@gmail.com',
                            subject: "Security Scan - ${currentBuild.result}",
                            body: """
The security scan has finished with status: ${currentBuild.result}

Please find the attached security scan log.

Build URL: ${env.BUILD_URL}
""",
                            attachments: 'security-scan.log'
                        )
                    }
                }
            }
        }

        stage('Deploy to Staging') {
            steps {
                echo 'Deploying to staging server on AWS EC2...'
            }
        }

        stage('Integration Tests on Staging') {
            steps {
                echo 'Running integration tests on the staging environment using Selenium...'
            }
        }

        stage('Deploy to Production') {
            steps {
                echo 'Deploying to production server on AWS EC2...'
            }
        }
    }
}
